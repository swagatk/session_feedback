<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Feedback</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }
        .star-rating input[type="radio"] {
            display: none;
        }
        .star-rating label {
            font-size: 2.5rem;
            color: #d1d5db; /* gray-300 */
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating input[type="radio"]:hover ~ label,
        .star-rating input[type="radio"]:checked ~ label {
            color: #f59e0b; /* amber-500 */
        }
        /* Custom styles for PDF export */
        @media print {
            body, html {
                height: auto;
            }
            #admin-panel {
                box-shadow: none;
            }
            .no-print {
                display: none !important;
            }
        }
        /* PDF export specific styles */
        .pdf-export {
            overflow: visible !important;
            box-shadow: none !important;
            border-radius: 0 !important;
        }
        .pdf-export table {
            border-collapse: collapse !important;
            width: 100% !important;
        }
        .pdf-export th,
        .pdf-export td {
            border: 1px solid #e5e7eb !important;
            padding: 8px !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        }
        .pdf-export .overflow-x-auto {
            overflow-x: visible !important;
        }
        .pdf-export .-mx-4,
        .pdf-export .-my-2,
        .pdf-export .sm\:-mx-6,
        .pdf-export .lg\:-mx-8 {
            margin: 0 !important;
        }
        #admin-panel {
            background: #fff;
        }
    </style>
</head>
<body class="h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">

    <!-- Admin Button -->
    <button id="admin-button" class="no-print fixed top-6 right-6 bg-gray-700 text-white py-2 px-4 rounded-lg shadow-md hover:bg-gray-800 transition duration-200 z-50" disabled>
        Loading...
    </button>

    <div class="max-w-2xl w-full space-y-8">

        <!-- Overall Rating Display (Admin Panel) -->
        <div id="admin-panel" class="hidden bg-white p-8 shadow-2xl rounded-2xl">
            
            <!-- Wrapper for PDF content -->
            <div id="pdf-content-wrapper">
                <h2 id="admin-panel-title" class="text-center text-3xl font-extrabold text-gray-900">
                    Overall Lecture Rating
                </h2>
                <!-- This div was missing, causing an error -->
                <div id="overall-rating-display" class="text-center text-7xl font-bold text-blue-600 my-4">
                    -- / 5.0
                </div>
                <div id="rating-count" class="text-center text-lg text-gray-500">
                    (No submissions yet)
                </div>

                <div id="selected-survey-display" class="text-center text-sm text-gray-500 mt-4 hidden"></div>
                <div id="survey-history-container" class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 text-left">Survey History</h3>
                    <div id="survey-history-list" class="mt-3 space-y-2"></div>
                </div>

                <!-- Feedback Table -->
                <div class="mt-8 flow-root">
                    <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                        <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                            <table class="min-w-full divide-y divide-gray-300">
                                <thead>
                                    <tr>
                                        <th scope="col" class="py-3.5 px-4 text-left text-sm font-semibold text-gray-900">Clarity</th>
                                        <th scope="col" class="py-3.5 px-4 text-left text-sm font-semibold text-gray-900">Engage</th>
                                        <th scope="col" class="py-3.5 px-4 text-left text-sm font-semibold text-gray-900">Pace</th>
                                        <th scope="col" class="py-3.5 px-4 text-left text-sm font-semibold text-gray-900">Positive</th>
                                        <th scope="col" class="py-3.5 px-4 text-left text-sm font-semibold text-gray-900">Improve</th>
                                        <th scope="col" class="py-3.5 px-4 text-left text-sm font-semibold text-gray-900">Submitted</th>
                                    </tr>
                                </thead>
                                <!-- This tbody was missing, causing an error -->
                                <tbody id="feedback-table-body" class="divide-y divide-gray-200 bg-white">
                                    <!-- Rows will be injected here by Firestore listener -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End of Wrapper for PDF content -->

            <!-- Admin Settings (Not in PDF) -->
            <div id="admin-settings" class="no-print mt-12 pt-8 border-t border-gray-200">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">Admin Settings</h3>
                <div class="space-y-6">
                    
                    <!-- Survey Management -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-green-800 mb-4">Survey Management</h4>
                        
                        <div class="grid gap-4 md:grid-cols-2 mb-4">
                            <div>
                                <label for="module-code-input" class="block text-sm font-medium text-gray-700">Module or Session Name</label>
                                <input type="text" id="module-code-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm" placeholder="e.g., CS101 Week 5" required>
                            </div>
                            <div>
                                <label for="lecture-date-input" class="block text-sm font-medium text-gray-700">Session Date</label>
                                <input type="date" id="lecture-date-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm" required>
                            </div>
                        </div>
                        <p class="text-xs text-gray-600 mb-4">Provide a clear module or session name and the lecture date so the generated survey link is easy to identify.</p>
                        
                        <!-- Create New Survey -->
                        <div class="mb-4">
                            <button id="create-survey-button" class="w-full inline-flex justify-center items-center px-4 py-3 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Create New Survey Link
                            </button>
                            <p class="mt-2 text-xs text-green-700">Creates a unique link that can be shared with students</p>
                        </div>
                        
                        <!-- Active Surveys List -->
                        <div id="surveys-list" class="space-y-3">
                            <p class="text-sm text-gray-600 italic">No active surveys yet. Create one to get started.</p>
                        </div>
                    </div>

                    <!-- Admin Account Settings -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Account Settings</h4>
                        
                        <!-- Recovery Email Info -->
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">
                                <strong>Admin Email:</strong> <span id="admin-email-display">Not logged in</span>
                            </p>
                            <p class="text-sm text-gray-500">
                                To change your password, use the "Forgot Password?" link on the login screen.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Admin Buttons -->
                    <button id="download-pdf-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 no-print">
                        Download Report as PDF
                    </button>
                    <button id="reset-feedback-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 no-print">
                        Reset All Feedback
                    </button>
                    <button id="logout-button" class="w-full flex justify-center py-3 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 no-print">
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Feedback Form -->
        <div id="feedback-form-container" class="bg-white p-8 shadow-2xl rounded-2xl">
            <h2 id="form-title" class="text-center text-3xl font-extrabold text-gray-900">
                Submit your feedback
            </h2>
            <form id="feedback-form" class="mt-8 space-y-6">
                <!-- Star Ratings -->
                <div class="rounded-md shadow-sm space-y-4 p-6 border border-gray-200">
                    <!-- Clarity -->
                    <div>
                        <label class="block text-lg font-medium text-gray-800">Clarity of Content</label>
                        <div class="star-rating">
                            <input type="radio" id="c5" name="clarity" value="5" required><label for="c5">&#9733;</label>
                            <input type="radio" id="c4" name="clarity" value="4"><label for="c4">&#9733;</label>
                            <input type="radio" id="c3" name="clarity" value="3"><label for="c3">&#9733;</label>
                            <input type="radio" id="c2" name="clarity" value="2"><label for="c2">&#9733;</label>
                            <input type="radio" id="c1" name="clarity" value="1"><label for="c1">&#9733;</label>
                        </div>
                    </div>
                    <!-- Engagement -->
                    <div>
                        <label class="block text-lg font-medium text-gray-800">Engagement</label>
                        <div class="star-rating">
                            <input type="radio" id="e5" name="engagement" value="5" required><label for="e5">&#9733;</label>
                            <input type="radio" id="e4" name="engagement" value="4"><label for="e4">&#9733;</label>
                            <input type="radio" id="e3" name="engagement" value="3"><label for="e3">&#9733;</label>
                            <input type="radio" id="e2" name="engagement" value="2"><label for="e2">&#9733;</label>
                            <input type="radio" id="e1" name="engagement" value="1"><label for="e1">&#9733;</label>
                        </div>
                    </div>
                    <!-- Pace -->
                    <div>
                        <label class="block text-lg font-medium text-gray-800">Pace of the Lecture</label>
                        <div class="star-rating">
                            <input type="radio" id="p5" name="pace" value="5" required><label for="p5">&#9733;</label>
                            <input type="radio" id="p4" name="pace" value="4"><label for="p4">&#9733;</label>
                            <input type="radio" id="p3" name="pace" value="3"><label for="p3">&#9733;</label>
                            <input type="radio" id="p2" name="pace" value="2"><label for="p2">&#9733;</label>
                            <input type="radio" id="p1" name="pace" value="1"><label for="p1">&#9733;</label>
                        </div>
                    </div>
                </div>
                
                <!-- Text Comments -->
                <div class="space-y-4">
                    <div>
                        <label for="positive-comments" class="block text-sm font-medium text-gray-700">What went well? (Positive Feedback)</label>
                        <textarea id="positive-comments" name="positive-comments" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                    </div>
                    <div>
                        <label for="negative-comments" class="block text-sm font-medium text-gray-700">What could be improved? (Constructive Feedback)</label>
                        <textarea id="negative-comments" name="negative-comments" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                    </div>
                </div>

                <div>
                    <button type="submit" class="group relative flex w-full justify-center rounded-md border border-transparent bg-blue-600 py-3 px-4 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Submit Feedback
                    </button>
                </div>
            </form>
        </div>

        <!-- Success Message -->
        <div id="success-message" class="hidden bg-white p-8 shadow-2xl rounded-2xl text-center">
            <h2 class="text-3xl font-extrabold text-gray-900">Thank You!</h2>
            <p class="mt-4 text-lg text-gray-600">Your feedback has been submitted successfully.</p>
        </div>

    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="hidden no-print fixed inset-0 z-50 overflow-y-auto bg-gray-500 bg-opacity-75 transition-opacity">
        <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div class="relative w-full max-w-md transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all">
                <h3 class="text-xl font-bold leading-6 text-gray-900">Admin Login</h3>
                <form id="admin-login-form" class="mt-4 space-y-4">
                    <div>
                        <label for="admin-email" class="block text-sm font-medium text-gray-700">Admin Email</label>
                        <input type="email" id="admin-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required placeholder="admin@example.com">
                    </div>
                    <div>
                        <label for="admin-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="admin-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                    </div>
                    <p id="admin-error-message" class="text-sm text-red-600 hidden">Login failed. Please check your credentials.</p>
                    <div class="flex gap-4">
                        <button type="button" id="admin-cancel-button" class="mt-4 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" id="admin-login-submit" class="mt-4 inline-flex w-full justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-blue-700">
                            Login
                        </button>
                    </div>
                    <div class="mt-4 text-center">
                        <button type="button" id="forgot-password-button" class="text-sm text-blue-600 hover:text-blue-500 underline">
                            Forgot Password?
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Password Recovery Modal -->
    <div id="password-recovery-modal" class="hidden no-print fixed inset-0 z-50 overflow-y-auto bg-gray-500 bg-opacity-75 transition-opacity">
        <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div class="relative w-full max-w-md transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all">
                <h3 class="text-xl font-bold leading-6 text-gray-900">Reset Password</h3>
                <div class="mt-4">
                    <p class="text-sm text-gray-600 mb-4">Enter your admin email address and we'll send you a link to reset your password.</p>
                    <form id="password-recovery-form" class="space-y-4">
                        <div>
                            <label for="recovery-email-check" class="block text-sm font-medium text-gray-700">Admin Email</label>
                            <input type="email" id="recovery-email-check" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required placeholder="admin@example.com">
                        </div>
                        <p id="recovery-error-message" class="text-sm text-red-600 hidden">Failed to send reset email.</p>
                        <p id="recovery-success-message" class="text-sm text-green-600 hidden">Password reset email sent! Check your inbox.</p>
                        <div class="flex gap-4">
                            <button type="button" id="recovery-cancel-button" class="mt-4 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" id="recovery-submit-button" class="mt-4 inline-flex w-full justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-blue-700">
                                Send Reset Email
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="hidden no-print fixed inset-0 z-50 overflow-y-auto bg-gray-500 bg-opacity-75 transition-opacity">
        <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div class="relative w-full max-w-md transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all">
                <h3 id="confirm-title" class="text-xl font-bold leading-6 text-gray-900">Are you sure?</h3>
                <div class="mt-2">
                    <p id="confirm-message" class="text-sm text-gray-500">Please confirm your action.</p>
                </div>
                <div class="mt-6 flex gap-4">
                    <button type="button" id="confirm-cancel-button" class="mt-4 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="button" id="confirm-ok-button" class="mt-4 inline-flex w-full justify-center rounded-md border border-transparent bg-red-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-red-700">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        console.log("üî¥ SCRIPT LOADING");
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            updatePassword,
            signOut,
            onAuthStateChanged,
            EmailAuthProvider,
            reauthenticateWithCredential
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query,
            where,
            getDocs,
            deleteDoc,
            Timestamp,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        console.log("‚úÖ All Firebase modules imported");

        document.addEventListener('DOMContentLoaded', () => {
            console.log("üöÄ DOM LOADED - Starting app");
            // --- CONSTANTS ---
            const SUBMITTED_KEY = "feedbackSubmitted"; // localStorage key (deprecated)
            const SURVEY_TOKEN_PREFIX = "survey_token_"; // Prefix for survey-specific tokens
            // Simplified paths for GitHub deployment
            const SURVEYS_COLLECTION = `surveys`;
            const SUBMISSIONS_COLLECTION = `survey-submissions`;
            const FEEDBACK_COLLECTION = `lecture-feedback`; // Legacy collection (deprecated)
            const SETTINGS_DOC = `app-settings/title`; // Deprecated - kept for backward compatibility
            const ADMIN_SETTINGS_DOC = `admin/settings`;
            // Admin email authorization
            const ADMIN_EMAILS = ['swagat.kumar@gmail.com']; // Only these emails can access admin panel

            // --- STATE ---
            let db, auth;
            let currentSurveyId = null; // Current survey ID from URL
            let isAdminLoggedIn = false;
            let currentUser = null;
            let confirmCallback = null;
            let feedbackListener = null; // To hold the onSnapshot unsubscribe function
            let titleListener = null; // To hold the onSnapshot unsubscribe function
            let adminSettings = { recoveryEmail: '' }; // Admin settings for recovery email
            let adminSelectedSurveyId = null; // Currently selected survey for admin view
            let adminSelectedSurveyName = '';
            const surveyMetadataById = new Map();

            // --- SELECTORS ---
            const adminButton = document.getElementById('admin-button');
            const adminLoginModal = document.getElementById('admin-login-modal');
            const adminLoginForm = document.getElementById('admin-login-form');
            const adminCancelButton = document.getElementById('admin-cancel-button');
            const adminErrorMessage = document.getElementById('admin-error-message');
            const adminLoginSubmit = document.getElementById('admin-login-submit');
            const forgotPasswordButton = document.getElementById('forgot-password-button');
            
            const passwordRecoveryModal = document.getElementById('password-recovery-modal');
            const passwordRecoveryForm = document.getElementById('password-recovery-form');
            const recoveryCancelButton = document.getElementById('recovery-cancel-button');
            const recoverySubmitButton = document.getElementById('recovery-submit-button');
            const recoveryErrorMessage = document.getElementById('recovery-error-message');
            const recoverySuccessMessage = document.getElementById('recovery-success-message');
            
            const feedbackFormContainer = document.getElementById('feedback-form-container');
            const feedbackForm = document.getElementById('feedback-form');
            const successMessage = document.getElementById('success-message');
            const formTitle = document.getElementById('form-title');

            const adminPanel = document.getElementById('admin-panel');
            const adminPanelTitle = document.getElementById('admin-panel-title');
            const logoutButton = document.getElementById('logout-button');
            const overallRatingDisplay = document.getElementById('overall-rating-display');
            const ratingCount = document.getElementById('rating-count');
            const selectedSurveyDisplay = document.getElementById('selected-survey-display');
            const surveyHistoryList = document.getElementById('survey-history-list');
            const adminEmailDisplay = document.getElementById('admin-email-display');
            
            const moduleCodeInput = document.getElementById('module-code-input');
            const saveTitleButton = document.getElementById('save-title-button');
            const titleSavedMessage = document.getElementById('title-saved-message');
            
            const lectureDateInput = document.getElementById('lecture-date-input');
            const saveDateButton = document.getElementById('save-date-button');
            const dateSavedMessage = document.getElementById('date-saved-message');
            
            const resetFeedbackButton = document.getElementById('reset-feedback-button');
            const downloadPdfButton = document.getElementById('download-pdf-button');
            
            const confirmModal = document.getElementById('confirm-modal');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmOkButton = document.getElementById('confirm-ok-button');
            const confirmCancelButton = document.getElementById('confirm-cancel-button');
            
            // Survey Management selectors
            const createSurveyButton = document.getElementById('create-survey-button');
            const surveysList = document.getElementById('surveys-list');
            
            // Optional elements that may not exist in UI (legacy/removed features)
            const recoveryEmailInput = document.getElementById('recovery-email-input');
            const emailSavedMessage = document.getElementById('email-saved-message');
            const currentPasswordInput = document.getElementById('current-password-input');
            const newPasswordInput = document.getElementById('new-password-input');
            const confirmPasswordInput = document.getElementById('confirm-password-input');
            const passwordChangeMessage = document.getElementById('password-change-message');

            // --- FUNCTIONS ---

            /**
             * Generates a unique survey ID.
             */
            function generateSurveyId() {
                return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
            }

            /**
             * Generates a browser fingerprint for device identification.
             * This creates a unique ID based on browser/device characteristics.
             */
            async function generateBrowserFingerprint() {
                const components = [
                    navigator.userAgent,
                    navigator.language,
                    navigator.platform,
                    navigator.hardwareConcurrency || 'unknown',
                    screen.colorDepth,
                    screen.width + 'x' + screen.height,
                    new Date().getTimezoneOffset(),
                    navigator.deviceMemory || 'unknown',
                    navigator.maxTouchPoints || 0
                ];

                // Add canvas fingerprint
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    ctx.textBaseline = 'top';
                    ctx.font = '14px Arial';
                    ctx.fillText('Browser fingerprint', 2, 2);
                    components.push(canvas.toDataURL());
                } catch (e) {
                    components.push('canvas-error');
                }

                // Create hash from components
                const fingerprint = components.join('|');
                const encoder = new TextEncoder();
                const data = encoder.encode(fingerprint);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                return 'fp_' + hashHex.substring(0, 32);
            }

            /**
             * Gets or creates a submission token for the current survey.
             * Now includes browser fingerprinting for cross-browser detection.
             */
            async function getOrCreateSurveyToken(surveyId) {
                const tokenKey = SURVEY_TOKEN_PREFIX + surveyId;
                let token = localStorage.getItem(tokenKey);
                
                if (!token) {
                    // Generate browser fingerprint
                    const fingerprint = await generateBrowserFingerprint();
                    
                    // Create a new unique token combining timestamp, random, and fingerprint
                    token = 'token_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15) + '_' + fingerprint;
                    localStorage.setItem(tokenKey, token);
                    console.log(`Created new token for survey ${surveyId} with fingerprint`);
                } else {
                    console.log(`Using existing token for survey ${surveyId}`);
                }
                
                return token;
            }

            /**
             * Builds the deterministic Firestore doc reference for a token submission.
             */
            function getSubmissionDocRef(surveyId, token) {
                return doc(db, SUBMISSIONS_COLLECTION, `${surveyId}_${token}`);
            }

            /**
             * Gets the current survey ID from URL parameters.
             */
            function getSurveyIdFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('survey');
            }

            /**
             * Initializes Firebase and sets up auth.
             */
            async function initializeFirebase() {
                try {
                    console.log("Starting Firebase initialization...");
                    
                    // Define placeholder strings that won't be replaced by GitHub Actions
                    const PLACEHOLDER_API = "YOUR" + "_API_KEY_" + "HERE";
                    const PLACEHOLDER_AUTH = "YOUR" + "_AUTH_DOMAIN_" + "HERE";
                    const PLACEHOLDER_PROJECT = "YOUR" + "_PROJECT_ID_" + "HERE";
                    
                    // --- IMPORTANT ---
                    // These placeholders will be replaced by the GitHub Action
                    const firebaseConfig = {
                        apiKey: "YOUR_API_KEY_HERE",
                        authDomain: "YOUR_AUTH_DOMAIN_HERE",
                        projectId: "YOUR_PROJECT_ID_HERE",
                        storageBucket: "YOUR_STORAGE_BUCKET_HERE",
                        messagingSenderId: "YOUR_MESSAGING_SENDER_ID_HERE",
                        appId: "YOUR_APP_ID_HERE"
                    };

                    console.log("Firebase config loaded. Validating...");
                    
                    // Clean and trim all config values to remove any invisible characters
                    const cleanConfig = {
                        apiKey: (firebaseConfig.apiKey || '').toString().trim(),
                        authDomain: (firebaseConfig.authDomain || '').toString().trim(),
                        projectId: (firebaseConfig.projectId || '').toString().trim(),
                        storageBucket: (firebaseConfig.storageBucket || '').toString().trim(),
                        messagingSenderId: (firebaseConfig.messagingSenderId || '').toString().trim(),
                        appId: (firebaseConfig.appId || '').toString().trim()
                    };
                    
                    // Quick check: Are we using placeholders? (Local development mode)
                    const isLocalDevelopment = cleanConfig.apiKey.includes("YOUR_API_KEY");
                    
                    if (isLocalDevelopment) {
                        console.warn("‚ö†Ô∏è Firebase config not set - Running in LOCAL TEST MODE");
                        console.warn("Firebase features will not work. This is for UI testing only.");
                        
                        // Enable admin button for local testing
                        adminButton.textContent = "Admin (Local Test Mode)";
                        adminButton.disabled = false;
                        adminButton.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                        adminButton.classList.remove('bg-gray-700', 'hover:bg-gray-800');
                        
                        // Show warning message
                        const warningMsg = document.createElement('div');
                        warningMsg.className = 'bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4';
                        warningMsg.innerHTML = `
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700">
                                        <strong>Local Test Mode:</strong> Firebase is not configured. Deploy to GitHub Pages for full functionality.
                                    </p>
                                </div>
                            </div>
                        `;
                        
                        const container = document.querySelector('.max-w-2xl');
                        if (container) {
                            container.insertBefore(warningMsg, container.firstChild);
                        }
                        
                        return; // Exit early - local test mode doesn't need Firebase
                    }

                    console.log("Config preview:", {
                        apiKey: cleanConfig.apiKey ? `${cleanConfig.apiKey.substring(0, 15)}...` : 'MISSING',
                        authDomain: cleanConfig.authDomain || 'MISSING',
                        projectId: cleanConfig.projectId || 'MISSING'
                    });
                    
                    // Debug raw values and their exact content
                    console.log("Raw config values for debugging:");
                    console.log("- apiKey length:", cleanConfig.apiKey.length);
                    console.log("- apiKey chars:", JSON.stringify(cleanConfig.apiKey));
                    console.log("- authDomain length:", cleanConfig.authDomain.length);
                    console.log("- authDomain chars:", JSON.stringify(cleanConfig.authDomain));
                    console.log("- projectId length:", cleanConfig.projectId.length);
                    console.log("- projectId chars:", JSON.stringify(cleanConfig.projectId));

                    // Debug each validation condition using cleaned values
                    console.log("Validation checks:");
                    
                    // Explicit comparison debugging - use strings that won't be replaced by GitHub Actions
                    console.log("=== DETAILED COMPARISON DEBUG ===");
                    console.log("apiKey comparison:");
                    console.log("  cleanConfig.apiKey:", JSON.stringify(cleanConfig.apiKey));
                    console.log("  placeholder:", JSON.stringify(PLACEHOLDER_API));
                    console.log("  equal?:", cleanConfig.apiKey === PLACEHOLDER_API);
                    console.log("  equal (loose)?:", cleanConfig.apiKey == PLACEHOLDER_API);
                    
                    console.log("authDomain comparison:");
                    console.log("  cleanConfig.authDomain:", JSON.stringify(cleanConfig.authDomain));
                    console.log("  placeholder:", JSON.stringify(PLACEHOLDER_AUTH));
                    console.log("  equal?:", cleanConfig.authDomain === PLACEHOLDER_AUTH);
                    
                    console.log("projectId comparison:");
                    console.log("  cleanConfig.projectId:", JSON.stringify(cleanConfig.projectId));
                    console.log("  placeholder:", JSON.stringify(PLACEHOLDER_PROJECT));
                    console.log("  equal?:", cleanConfig.projectId === PLACEHOLDER_PROJECT);
                    console.log("=== END DETAILED DEBUG ===");
                    
                    console.log("- apiKey === placeholder:", cleanConfig.apiKey === PLACEHOLDER_API);
                    console.log("- authDomain === placeholder:", cleanConfig.authDomain === PLACEHOLDER_AUTH);
                    console.log("- projectId === placeholder:", cleanConfig.projectId === PLACEHOLDER_PROJECT);
                    console.log("- apiKey missing:", !cleanConfig.apiKey);
                    console.log("- authDomain missing:", !cleanConfig.authDomain);
                    console.log("- projectId missing:", !cleanConfig.projectId);
                    console.log("- apiKey too short:", cleanConfig.apiKey && cleanConfig.apiKey.length < 10);
                    console.log("- authDomain no dot:", cleanConfig.authDomain && !cleanConfig.authDomain.includes('.'));
                    console.log("- projectId too short:", cleanConfig.projectId && cleanConfig.projectId.length < 3);

                    // Check if placeholders are still present or if values are invalid using cleaned values
                    // Use placeholder strings that won't be replaced by GitHub Actions
                    const hasPlaceholders = (
                        cleanConfig.apiKey.includes(PLACEHOLDER_API) ||
                        cleanConfig.authDomain.includes(PLACEHOLDER_AUTH) ||
                        cleanConfig.projectId.includes(PLACEHOLDER_PROJECT)
                    );
                    
                    const hasEmptyValues = (
                        !cleanConfig.apiKey ||
                        !cleanConfig.authDomain ||
                        !cleanConfig.projectId
                    );
                    
                    const hasInvalidValues = (
                        cleanConfig.apiKey.length < 10 ||
                        !cleanConfig.authDomain.includes('.') ||
                        cleanConfig.projectId.length < 3
                    );
                    
                    const isInvalidConfig = hasPlaceholders || hasEmptyValues || hasInvalidValues;
                    
                    console.log("Simplified validation:");
                    console.log("- hasPlaceholders:", hasPlaceholders);
                    console.log("- hasEmptyValues:", hasEmptyValues);
                    console.log("- hasInvalidValues:", hasInvalidValues);
                    console.log("Overall validation result - isInvalidConfig:", isInvalidConfig);

                    if (isInvalidConfig) {
                        console.error("Firebase config is not set properly. Config values:", cleanConfig);
                        
                        let errorDetails = "Firebase configuration issues detected:\n";
                        
                        // Check each condition individually using the new validation approach
                        if (cleanConfig.apiKey.includes("YOUR_API_KEY_HERE")) {
                            errorDetails += "‚Ä¢ API Key placeholder not replaced\n";
                        } else if (!cleanConfig.apiKey) {
                            errorDetails += "‚Ä¢ API Key is empty\n";
                        } else if (cleanConfig.apiKey.length < 10) {
                            errorDetails += `‚Ä¢ API Key appears invalid (length: ${cleanConfig.apiKey.length})\n`;
                        }
                        
                        if (cleanConfig.authDomain.includes("YOUR_AUTH_DOMAIN_HERE")) {
                            errorDetails += "‚Ä¢ Auth Domain placeholder not replaced\n";
                        } else if (!cleanConfig.authDomain) {
                            errorDetails += "‚Ä¢ Auth Domain is empty\n";
                        } else if (!cleanConfig.authDomain.includes('.')) {
                            errorDetails += `‚Ä¢ Auth Domain appears invalid (no dot): ${cleanConfig.authDomain}\n`;
                        }
                        
                        if (cleanConfig.projectId.includes("YOUR_PROJECT_ID_HERE")) {
                            errorDetails += "‚Ä¢ Project ID placeholder not replaced\n";
                        } else if (!cleanConfig.projectId) {
                            errorDetails += "‚Ä¢ Project ID is empty\n";
                        } else if (cleanConfig.projectId.length < 3) {
                            errorDetails += `‚Ä¢ Project ID appears invalid (length: ${cleanConfig.projectId.length})\n`;
                        }
                        
                        // If none of the above, there might be a logic error
                        if (errorDetails === "Firebase configuration issues detected:\n") {
                            errorDetails += "‚Ä¢ Unknown validation error - all values appear correct\n";
                            errorDetails += `‚Ä¢ Debug: apiKey length=${cleanConfig.apiKey?.length}, authDomain=${cleanConfig.authDomain}, projectId length=${cleanConfig.projectId?.length}\n`;
                        }
                        
                        displayError("Config Error", errorDetails);
                        
                        // Enable admin button to show config error state
                        adminButton.textContent = "Admin (Config Error)";
                        adminButton.disabled = false;
                        adminButton.classList.add('bg-red-600', 'hover:bg-red-700');
                        adminButton.classList.remove('bg-gray-700', 'hover:bg-gray-800');
                        
                        return;
                    }

                    console.log("‚úÖ Firebase config validation passed successfully!");
                    console.log("Initializing Firebase app with valid configuration...");
                    
                    // Use the cleaned config for Firebase initialization
                    const validFirebaseConfig = {
                        apiKey: cleanConfig.apiKey,
                        authDomain: cleanConfig.authDomain,
                        projectId: cleanConfig.projectId,
                        storageBucket: cleanConfig.storageBucket,
                        messagingSenderId: cleanConfig.messagingSenderId,
                        appId: cleanConfig.appId
                    };

                    console.log("Firebase config validation passed. Initializing app...");
                    const app = initializeApp(validFirebaseConfig);
                    console.log("Firebase app initialized successfully");
                    
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase services initialized");

                    // Set up authentication state listener
                    onAuthStateChanged(auth, async (user) => {
                        console.log("Auth state changed:", user ? `User: ${user.email || 'Anonymous'}` : 'No user');
                        currentUser = user;
                        
                        if (user && !user.isAnonymous) {
                            // Check if this email is authorized as admin
                            if (ADMIN_EMAILS.includes(user.email)) {
                                // Authorized admin user logged in
                                isAdminLoggedIn = true;
                                adminEmailDisplay.textContent = user.email;
                                console.log("Admin access granted for:", user.email);
                            } else {
                                // Unauthorized email - sign them out
                                console.log("Unauthorized admin attempt:", user.email);
                                isAdminLoggedIn = false;
                                adminEmailDisplay.textContent = "Not logged in";
                                signOut(auth);
                                alert("Unauthorized: This email is not authorized for admin access.");
                                return;
                            }
                        } else {
                            // Anonymous user or no user
                            isAdminLoggedIn = false;
                            adminEmailDisplay.textContent = "Not logged in";
                        }

                        await updateView();
                    });

                    // Sign in anonymously for public access (students)
                    console.log("Starting anonymous authentication for public access...");
                    await signInAnonymously(auth);
                    console.log("Anonymous sign-in successful");

                    console.log("Authentication complete. Starting listeners...");
                    
                    // Check if there's a survey ID in URL
                    currentSurveyId = getSurveyIdFromURL();
                    
                    if (currentSurveyId) {
                        console.log("Survey ID found in URL:", currentSurveyId);
                        await initializeSurvey(currentSurveyId);
                    } else {
                        console.log("No survey ID in URL - showing default view");
                        // For backward compatibility, listen for old format
                        listenForTitle();
                    }
                    
                    console.log("Firebase initialization complete!");
                    
                    // Update admin button to show system is ready
                    adminButton.textContent = "Admin";
                    adminButton.disabled = false;

                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    const errorMessage = `Firebase initialization failed:\n\nError: ${error.name}\nMessage: ${error.message}\nStack: ${error.stack}`;
                    displayError("Firebase Error", errorMessage);
                    
                    // Enable admin button even if Firebase fails, so user can see the error
                    adminButton.textContent = "Admin (Error)";
                    adminButton.disabled = false;
                    adminButton.classList.add('bg-red-600', 'hover:bg-red-700');
                    adminButton.classList.remove('bg-gray-700', 'hover:bg-gray-800');
                }
            }
            
            /**
             * Displays a fatal error in the admin panel and form.
             */
            function displayError(title, message) {
                adminPanelTitle.textContent = "Error";
                overallRatingDisplay.textContent = title;
                overallRatingDisplay.classList.add('text-red-600', 'text-3xl');
                overallRatingDisplay.classList.remove('text-7xl', 'text-blue-600');
                
                // Create detailed error message with better formatting
                const errorHtml = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-red-800 mb-2">${title}</h3>
                        <div class="text-sm text-red-700 whitespace-pre-line">${message}</div>
                        <div class="mt-4 text-xs text-red-600">
                            <strong>Debug Info:</strong><br>
                            ‚Ä¢ Timestamp: ${new Date().toISOString()}<br>
                            ‚Ä¢ User Agent: ${navigator.userAgent.substring(0, 50)}...<br>
                            ‚Ä¢ Location: ${window.location.href}
                        </div>
                    </div>
                `;
                
                ratingCount.innerHTML = errorHtml;
                
                formTitle.textContent = "Configuration Error";
                feedbackFormContainer.innerHTML = `
                    <div class="text-center">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-red-800 mb-2">${title}</h3>
                            <div class="text-sm text-red-700 whitespace-pre-line mb-4">${message}</div>
                            <div class="text-xs text-red-600">
                                Please contact the administrator to resolve this issue.
                            </div>
                        </div>
                    </div>
                `;
                
                // Disable all buttons
                const buttons = document.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
            }

            /**
             * Shows or hides UI elements based on admin login status.
             */
            async function updateView() {
                if (!db) return; // Don't do anything if DB isn't ready

                if (isAdminLoggedIn) {
                    feedbackFormContainer.classList.add('hidden');
                    successMessage.classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                    adminButton.classList.add('hidden');

                    await loadAdminPanelData();
                    await loadSurveys(); // Load active surveys list
                    await loadSurveyHistory();
                } else {
                    // Stop admin listener
                    if (feedbackListener) {
                        feedbackListener(); // Unsubscribe
                        feedbackListener = null;
                    }

                    adminSelectedSurveyId = null;
                    adminSelectedSurveyName = '';
                    if (selectedSurveyDisplay) {
                        selectedSurveyDisplay.classList.add('hidden');
                        selectedSurveyDisplay.textContent = '';
                    }
                    if (surveyHistoryList) {
                        surveyHistoryList.innerHTML = '';
                    }

                    // For students, always show the form if not on a survey page
                    if (!currentSurveyId) {
                        feedbackFormContainer.classList.remove('hidden');
                        successMessage.classList.add('hidden');
                    }
                    
                    adminPanel.classList.add('hidden');
                    adminButton.classList.remove('hidden');
                }
                adminLoginModal.classList.add('hidden');
            }

            /**
             * Loads one-time data for the admin panel (like module code and admin settings).
             */
            async function loadAdminPanelData() {
                try {
                    // Load module code and date
                    const titleDocRef = doc(db, SETTINGS_DOC);
                    const titleDocSnap = await getDoc(titleDocRef);
                    let moduleCode = "";
                    let lectureDate = "";
                    if (titleDocSnap.exists()) {
                        const data = titleDocSnap.data();
                        moduleCode = data.moduleCode || "";
                        lectureDate = data.lectureDate || "";
                    }
                    
                    // Set module code
                    moduleCodeInput.value = moduleCode;
                    
                    // Set date - default to today if not set
                    if (!lectureDate) {
                        lectureDate = new Date().toISOString().split('T')[0];
                    }
                    lectureDateInput.value = lectureDate;
                    
                    // Update admin panel title
                    adminPanelTitle.innerHTML = "Overall Lecture Rating<br>-------------------";

                    // Load admin settings (recovery email)
                    const adminDocRef = doc(db, ADMIN_SETTINGS_DOC);
                    const adminDocSnap = await getDoc(adminDocRef);
                    if (adminDocSnap.exists()) {
                        const data = adminDocSnap.data();
                        adminSettings.recoveryEmail = data.recoveryEmail || "";
                    } else {
                        // Initialize admin settings if they don't exist
                        adminSettings.recoveryEmail = "";
                        await setDoc(adminDocRef, { recoveryEmail: "" });
                    }
                    if (recoveryEmailInput) {
                        recoveryEmailInput.value = adminSettings.recoveryEmail;
                    }
                } catch (error) {
                    console.error("Error loading admin panel data:", error);
                    // Set default values on error
                    const today = new Date().toISOString().split('T')[0];
                    moduleCodeInput.value = "";
                    lectureDateInput.value = today;
                    adminPanelTitle.innerHTML = `Overall Rating<br>-------------------`;
                }
            }

            /**
             * Creates a new survey and generates a unique link.
             */
            async function createSurvey() {
                try {
                    const moduleCode = moduleCodeInput.value.trim();
                    const lectureDate = lectureDateInput.value;
                    
                    if (!moduleCode) {
                        alert("Please enter a module code before creating a survey.");
                        return;
                    }
                    
                    if (!lectureDate) {
                        alert("Please select a lecture date before creating a survey.");
                        return;
                    }
                    
                    const surveyId = generateSurveyId();
                    
                    // Create survey document
                    const surveyData = {
                        id: surveyId,
                        moduleCode: moduleCode,
                        lectureDate: lectureDate,
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser.email,
                        active: true
                    };
                    
                    await setDoc(doc(db, SURVEYS_COLLECTION, surveyId), surveyData);
                    console.log("‚úÖ Survey created:", surveyId);
                    
                    // Reload surveys list and history
                    await loadSurveys();
                    await loadSurveyHistory();
                    
                    // Select the newly created survey
                    adminSelectedSurveyId = surveyId;
                    adminSelectedSurveyName = buildSurveyBaseName(surveyData);
                    highlightSurveyHistorySelection();
                    updateSelectedSurveyDisplay();
                    listenForFeedback(adminSelectedSurveyId);
                    
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'mt-2 text-green-600 text-sm';
                    successMsg.textContent = '‚úì Survey created successfully!';
                    createSurveyButton.parentNode.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                    
                } catch (error) {
                    console.error("‚ùå Error creating survey:", error);
                    alert("Failed to create survey: " + error.message);
                }
            }

            /**
             * Loads and displays all active surveys.
             */
            async function loadSurveys() {
                try {
                    const q = query(
                        collection(db, SURVEYS_COLLECTION),
                        where('active', '==', true)
                    );
                    
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        surveysList.innerHTML = '<p class="text-gray-500 text-sm">No active surveys. Create one to get started!</p>';
                        return;
                    }
                    
                    surveysList.innerHTML = '';
                    
                    querySnapshot.forEach((doc) => {
                        const survey = doc.data();
                        const surveyItem = document.createElement('div');
                        surveyItem.className = 'bg-gray-50 p-3 rounded border border-gray-200 mb-2';
                        
                        const surveyLink = `${window.location.origin}${window.location.pathname}?survey=${survey.id}`;
                        const displayName = survey.displayName || `${survey.moduleCode || 'Survey'}-${survey.lectureDate || 'Date'}`;
                        const createdAtDate = survey.createdAt ? new Date(survey.createdAt) : null;
                        const createdDisplay = createdAtDate && !Number.isNaN(createdAtDate.getTime())
                            ? createdAtDate.toLocaleDateString()
                            : 'Unknown';
                        
                        surveyItem.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">${displayName}</div>
                                    <div class="text-sm text-gray-600">Module: ${survey.moduleCode || 'N/A'}</div>
                                    <div class="text-sm text-gray-600">Date: ${survey.lectureDate || 'N/A'}</div>
                                    <div class="mt-1 text-xs text-gray-500">Created: ${createdDisplay}</div>
                                    <div class="mt-2 flex items-center gap-2">
                                        <input type="text" readonly value="${surveyLink}" 
                                               class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded bg-white"
                                               onclick="this.select()">
                                        <button onclick="copySurveyLink('${surveyLink}', event)" 
                                                class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                                            Copy Link
                                        </button>
                                    </div>
                                </div>
                                <button onclick="deactivateSurvey('${survey.id}')" 
                                        class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">
                                    Deactivate
                                </button>
                            </div>
                        `;
                        
                        surveysList.appendChild(surveyItem);
                    });
                    
                } catch (error) {
                    console.error("‚ùå Error loading surveys:", error);
                    surveysList.innerHTML = '<p class="text-red-500 text-sm">Failed to load surveys.</p>';
                }
            }

            /**
             * Builds a consistent base name for a survey using module code and date.
             */
            function buildSurveyBaseName(survey) {
                const modulePart = (survey.moduleCode || 'Survey').trim() || 'Survey';
                let datePart = '';

                if (survey.lectureDate) {
                    datePart = survey.lectureDate;
                } else if (survey.createdAt) {
                    const parsedDate = new Date(survey.createdAt);
                    if (!Number.isNaN(parsedDate.getTime())) {
                        datePart = parsedDate.toISOString().split('T')[0];
                    }
                }

                if (!datePart) {
                    datePart = 'undated';
                }

                return `${modulePart}-${datePart}`;
            }

            /**
             * Updates the summary chip showing which survey is active.
             */
            function updateSelectedSurveyDisplay() {
                if (!selectedSurveyDisplay) {
                    return;
                }

                if (!adminSelectedSurveyId || !surveyMetadataById.has(adminSelectedSurveyId)) {
                    selectedSurveyDisplay.classList.add('hidden');
                    selectedSurveyDisplay.textContent = '';
                    return;
                }

                const metadata = surveyMetadataById.get(adminSelectedSurveyId);
                const infoParts = [`Viewing: ${metadata.displayName}`];
                if (metadata.lectureDate) {
                    infoParts.push(`Date: ${metadata.lectureDate}`);
                }
                infoParts.push(metadata.active ? 'Active' : 'Closed');

                selectedSurveyDisplay.textContent = infoParts.join(' | ');
                selectedSurveyDisplay.classList.remove('hidden');
            }

            /**
             * Applies visual styling to the selected survey history entry.
             */
            function highlightSurveyHistorySelection() {
                if (!surveyHistoryList) {
                    return;
                }

                const rows = surveyHistoryList.querySelectorAll('[data-survey-id]');
                rows.forEach((row) => {
                    const isSelected = adminSelectedSurveyId && row.dataset.surveyId === adminSelectedSurveyId;
                    row.classList.toggle('border-blue-500', !!isSelected);
                    row.classList.toggle('bg-blue-50', !!isSelected);
                    row.classList.toggle('border-gray-200', !isSelected);
                    row.classList.toggle('bg-gray-50', !isSelected);
                });
            }

            /**
             * Handles survey selection from the history list.
             */
            function handleSurveyHistorySelect(surveyId) {
                if (!surveyId || !surveyMetadataById.has(surveyId)) {
                    console.warn('Survey metadata not found for selection', surveyId);
                    return;
                }

                const metadata = surveyMetadataById.get(surveyId);
                adminSelectedSurveyId = surveyId;
                adminSelectedSurveyName = metadata.displayName;

                highlightSurveyHistorySelection();
                updateSelectedSurveyDisplay();
                listenForFeedback(adminSelectedSurveyId);
            }

            /**
             * Handles deletion of a survey and its submissions.
             */
            function handleSurveyHistoryDelete(surveyId) {
                if (!surveyId) {
                    return;
                }

                const metadata = surveyMetadataById.get(surveyId);
                const surveyLabel = metadata ? metadata.displayName : 'this survey';

                showCustomConfirm(
                    'Delete Survey?',
                    `This will delete "${surveyLabel}" and all associated submissions. This action cannot be undone.`,
                    async () => {
                        try {
                            const submissionsQuery = query(
                                collection(db, SUBMISSIONS_COLLECTION),
                                where('surveyId', '==', surveyId)
                            );
                            const submissionsSnapshot = await getDocs(submissionsQuery);
                            const deletionJobs = submissionsSnapshot.docs.map((docSnap) => deleteDoc(docSnap.ref));
                            if (deletionJobs.length > 0) {
                                await Promise.all(deletionJobs);
                            }

                            await deleteDoc(doc(db, SURVEYS_COLLECTION, surveyId));

                            if (adminSelectedSurveyId === surveyId) {
                                adminSelectedSurveyId = null;
                                adminSelectedSurveyName = '';
                            }

                            await loadSurveyHistory();
                            await loadSurveys();
                        } catch (error) {
                            console.error('Error deleting survey:', error);
                            alert('Failed to delete survey: ' + error.message);
                        }
                    },
                    'Delete'
                );
            }

            /**
             * Creates a DOM node for a survey history entry.
             */
            function createSurveyHistoryRow(metadata) {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-3 border border-gray-200 rounded-lg px-3 py-2 bg-gray-50';
                row.dataset.surveyId = metadata.id;

                const selectButton = document.createElement('button');
                selectButton.type = 'button';
                selectButton.className = 'flex-1 text-left text-sm font-medium text-gray-700 hover:text-blue-600 focus:outline-none';

                const titleSpan = document.createElement('span');
                titleSpan.className = 'block';
                titleSpan.textContent = metadata.displayName;

                const detailsSpan = document.createElement('span');
                detailsSpan.className = 'block text-xs text-gray-500';
                const detailParts = [];
                if (metadata.moduleCode) {
                    detailParts.push(metadata.moduleCode);
                }
                if (metadata.lectureDate) {
                    detailParts.push(metadata.lectureDate);
                }
                detailParts.push(metadata.active ? 'Active' : 'Closed');
                detailsSpan.textContent = detailParts.join(' | ');

                selectButton.appendChild(titleSpan);
                selectButton.appendChild(detailsSpan);
                selectButton.addEventListener('click', () => handleSurveyHistorySelect(metadata.id));

                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.className = 'px-2 py-1 text-xs text-red-600 border border-red-200 rounded hover:bg-red-50';
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    handleSurveyHistoryDelete(metadata.id);
                });

                row.appendChild(selectButton);
                row.appendChild(deleteButton);

                return row;
            }

            /**
             * Loads survey history entries for the admin view.
             */
            async function loadSurveyHistory() {
                console.log("loadSurveyHistory called");
                console.log("db exists?", !!db);
                console.log("surveyHistoryList exists?", !!surveyHistoryList);
                
                if (!db) {
                    console.warn("Cannot load survey history - db not initialized");
                    return;
                }
                
                if (!surveyHistoryList) {
                    console.error("Cannot load survey history - surveyHistoryList element not found");
                    return;
                }

                surveyHistoryList.innerHTML = '<p class="text-sm text-gray-500">Loading surveys...</p>';

                try {
                    console.log("üìã Loading survey history...");
                    const snapshot = await getDocs(collection(db, SURVEYS_COLLECTION));
                    console.log(`Found ${snapshot.size} surveys in Firestore`);
                    
                    const surveys = [];
                    snapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        surveys.push({
                            id: docSnap.id,
                            ...data
                        });
                    });

                    if (surveys.length === 0) {
                        surveyHistoryList.innerHTML = '<p class="text-sm text-gray-500">No surveys created yet.</p>';
                        adminSelectedSurveyId = null;
                        adminSelectedSurveyName = '';
                        updateSelectedSurveyDisplay();
                        listenForFeedback(null);
                        return;
                    }

                    const ascending = [...surveys].sort((a, b) => {
                        const aTime = Date.parse(a.createdAt || '') || 0;
                        const bTime = Date.parse(b.createdAt || '') || 0;
                        return aTime - bTime;
                    });

                    const computedNames = new Map();
                    const groupCounters = new Map();
                    const displayNameUpdates = [];

                    ascending.forEach((survey) => {
                        const baseName = buildSurveyBaseName(survey);
                        const counter = groupCounters.get(baseName) || 0;
                        let displayName = survey.displayName;

                        if (!displayName) {
                            displayName = counter === 0 ? baseName : `${baseName}-${counter}`;
                            displayNameUpdates.push(
                                setDoc(doc(db, SURVEYS_COLLECTION, survey.id), { displayName }, { merge: true })
                                    .catch(err => console.warn(`Failed to update displayName for ${survey.id}:`, err))
                            );
                        }

                        groupCounters.set(baseName, counter + 1);
                        computedNames.set(survey.id, displayName);
                    });

                    if (displayNameUpdates.length > 0) {
                        console.log(`Updating display names for ${displayNameUpdates.length} surveys...`);
                        await Promise.all(displayNameUpdates);
                    }

                    const descending = [...surveys].sort((a, b) => {
                        const aTime = Date.parse(a.createdAt || '') || 0;
                        const bTime = Date.parse(b.createdAt || '') || 0;
                        return bTime - aTime;
                    });

                    surveyMetadataById.clear();
                    surveyHistoryList.innerHTML = '';

                    descending.forEach((survey) => {
                        const displayName = computedNames.get(survey.id) || buildSurveyBaseName(survey);
                        const metadata = {
                            id: survey.id,
                            displayName,
                            moduleCode: survey.moduleCode || '',
                            lectureDate: survey.lectureDate || '',
                            active: survey.active !== false,
                            createdAt: survey.createdAt || ''
                        };
                        surveyMetadataById.set(survey.id, metadata);
                        surveyHistoryList.appendChild(createSurveyHistoryRow(metadata));
                    });

                    if (!adminSelectedSurveyId || !surveyMetadataById.has(adminSelectedSurveyId)) {
                        const firstSurvey = descending[0];
                        adminSelectedSurveyId = firstSurvey.id;
                        adminSelectedSurveyName = computedNames.get(firstSurvey.id) || buildSurveyBaseName(firstSurvey);
                    }

                    console.log("Highlighting selection and updating display...");
                    highlightSurveyHistorySelection();
                    updateSelectedSurveyDisplay();
                    
                    console.log("Starting feedback listener for survey:", adminSelectedSurveyId);
                    listenForFeedback(adminSelectedSurveyId);
                    
                    console.log("‚úÖ Survey history loaded successfully");
                } catch (error) {
                    console.error('‚ùå Error loading survey history:', error);
                    console.error('Error details:', error.message, error.stack);
                    if (surveyHistoryList) {
                        surveyHistoryList.innerHTML = `<p class="text-sm text-red-500">Failed to load survey history: ${error.message}</p>`;
                    }
                }
            }

            /**
             * Copies survey link to clipboard.
             */
            window.copySurveyLink = async function(link, evt) {
                try {
                    await navigator.clipboard.writeText(link);
                    
                    // Show temporary success message
                    const button = evt ? evt.target : event.target;
                    if (!button) {
                        alert("Link copied to clipboard!");
                        return;
                    }
                    
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    button.classList.add('bg-green-500');
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('bg-green-500');
                        button.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    }, 2000);
                    
                } catch (error) {
                    console.error("‚ùå Error copying link:", error);
                    alert("Failed to copy link. Please copy manually.");
                }
            };

            /**
             * Deactivates a survey.
             */
            window.deactivateSurvey = async function(surveyId) {
                if (!confirm("Are you sure you want to deactivate this survey? Students will no longer be able to submit feedback.")) {
                    return;
                }
                
                try {
                    await setDoc(doc(db, SURVEYS_COLLECTION, surveyId), { active: false }, { merge: true });
                    console.log("‚úÖ Survey deactivated:", surveyId);
                    
                    // Reload surveys list and survey history
                    await loadSurveys();
                    await loadSurveyHistory();
                    
                } catch (error) {
                    console.error("‚ùå Error deactivating survey:", error);
                    alert("Failed to deactivate survey: " + error.message);
                }
            };

            /**
             * Listens for feedback data from Firestore and updates the admin panel.
             * Now listens to the new survey-submissions collection.
             */
            function listenForFeedback(selectedSurveyId) {
                if (feedbackListener) {
                    feedbackListener(); // Unsubscribe from old listener
                    feedbackListener = null;
                }

                if (!db) {
                    return;
                }

                if (!selectedSurveyId) {
                    overallRatingDisplay.textContent = '-- / 5.0';
                    ratingCount.textContent = '(Select a survey to view results)';
                    renderFeedbackTable([]);
                    return;
                }

                const feedbackQuery = query(
                    collection(db, SUBMISSIONS_COLLECTION),
                    where('surveyId', '==', selectedSurveyId)
                );
                feedbackListener = onSnapshot(feedbackQuery, (querySnapshot) => {
                    const feedback = [];
                    querySnapshot.forEach((docSnap) => {
                        feedback.push(docSnap.data());
                    });
                    
                    console.log(`üìä Feedback listener received ${feedback.length} submissions for survey ${selectedSurveyId}`);
                    
                    calculateOverallRating(feedback);
                    renderFeedbackTable(feedback);
                }, (error) => {
                    console.error("Error listening for feedback:", error);
                    displayError("Listener Error", "Could not get feedback data.");
                });
            }

            /**
             * Initializes and validates a survey from URL parameter.
             */
            async function initializeSurvey(surveyId) {
                try {
                    // Check if survey exists
                    const surveyDocRef = doc(db, SURVEYS_COLLECTION, surveyId);
                    const surveySnap = await getDoc(surveyDocRef);
                    
                    if (!surveySnap.exists()) {
                        displayError("Invalid Survey", "This survey link is not valid or has been deleted.");
                        return;
                    }
                    
                    const surveyData = surveySnap.data();
                    
                    // Check if survey is active
                    if (!surveyData.active) {
                        displayError("Survey Closed", "This survey is no longer accepting responses.");
                        return;
                    }
                    
                    // Get or create submission token for this survey
                    const token = await getOrCreateSurveyToken(surveyId);
                    
                    // Check if this token has already been used
                    const hasSubmitted = await checkTokenSubmission(surveyId, token);
                    
                    if (hasSubmitted) {
                        // Show success message
                        feedbackFormContainer.classList.add('hidden');
                        successMessage.classList.remove('hidden');
                        console.log("Token already used for this survey");
                        return;
                    }
                    
                    // Check if this device fingerprint has already submitted (cross-browser detection)
                    const fingerprint = await generateBrowserFingerprint();
                    const hasFingerprintSubmitted = await checkFingerprintSubmission(surveyId, fingerprint);
                    
                    if (hasFingerprintSubmitted) {
                        displayError(
                            "Already Submitted", 
                            "Feedback has already been submitted from this device for this survey. Multiple submissions from the same device are not allowed."
                        );
                        return;
                    }
                    
                    // Show the form with survey details
                    formTitle.innerHTML = `${surveyData.moduleCode}:${surveyData.lectureDate}<br>Submit your feedback`;
                    feedbackFormContainer.classList.remove('hidden');
                    successMessage.classList.add('hidden');
                    
                    console.log("Survey initialized successfully:", surveyData);
                    
                } catch (error) {
                    console.error("Error initializing survey:", error);
                    displayError("Error", "Could not load survey. Please try again later.");
                }
            }

            /**
             * Checks if a token has already been used for a survey.
             */
            async function checkTokenSubmission(surveyId, token) {
                try {
                    const submissionDocRef = getSubmissionDocRef(surveyId, token);
                    const submissionSnap = await getDoc(submissionDocRef);
                    if (submissionSnap.exists()) {
                        return true;
                    }

                    // Fallback for legacy submissions saved under random doc IDs
                    const legacyQuery = query(
                        collection(db, SUBMISSIONS_COLLECTION),
                        where('surveyId', '==', surveyId),
                        where('token', '==', token)
                    );
                    const legacySnapshot = await getDocs(legacyQuery);

                    if (!legacySnapshot.empty) {
                        const legacyData = legacySnapshot.docs[0].data();
                        try {
                            await setDoc(submissionDocRef, legacyData);
                        } catch (migrationError) {
                            console.warn("Token migration skipped:", migrationError);
                        }
                        return true;
                    }

                    return false;
                } catch (error) {
                    console.error("Error checking token submission:", error);
                    return false;
                }
            }

            /**
             * Checks if a device fingerprint has already been used for a survey.
             * This prevents resubmission from different browsers on the same device.
             */
            async function checkFingerprintSubmission(surveyId, fingerprint) {
                try {
                    const fingerprintQuery = query(
                        collection(db, SUBMISSIONS_COLLECTION),
                        where('surveyId', '==', surveyId),
                        where('fingerprint', '==', fingerprint)
                    );
                    const fingerprintSnapshot = await getDocs(fingerprintQuery);
                    
                    if (!fingerprintSnapshot.empty) {
                        console.warn('Device fingerprint already used for this survey:', fingerprint);
                        return true;
                    }
                    
                    return false;
                } catch (error) {
                    console.error("Error checking fingerprint submission:", error);
                    // On error, allow submission to avoid false blocking
                    return false;
                }
            }

            /**
             * Listens for title changes from Firestore and updates the student form.
             * DEPRECATED: This is kept for backward compatibility but should not be used.
             */
            function listenForTitle() {
                if (titleListener) titleListener(); // Unsubscribe from old listener

                titleListener = onSnapshot(doc(db, SETTINGS_DOC), async (docSnap) => {
                    let moduleCode = "";
                    let lectureDate = "";
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        moduleCode = data.moduleCode || "";
                        lectureDate = data.lectureDate || "";
                    }
                    
                    // Format title with module code and date
                    if (moduleCode && lectureDate) {
                        formTitle.innerHTML = `${moduleCode}:${lectureDate}<br>Submit your feedback`;
                    } else if (moduleCode) {
                        formTitle.innerHTML = `${moduleCode}<br>Submit your feedback`;
                    } else {
                        formTitle.textContent = "Submit your feedback";
                    }
                }, (error) => {
                    console.error("Error listening for title:", error);
                    // Don't show a fatal error, just use the default title
                    formTitle.textContent = "Submit your feedback";
                });
            }

            /**
             * Calculates and displays the overall average rating.
             */
            function calculateOverallRating(feedback) {
                if (feedback.length === 0) {
                    overallRatingDisplay.textContent = '-- / 5.0';
                    ratingCount.textContent = '(No submissions yet)';
                    return;
                }

                const totalSum = feedback.reduce((acc, entry) => acc + entry.average, 0);
                const overallAverage = totalSum / feedback.length;

                overallRatingDisplay.textContent = `${overallAverage.toFixed(1)} / 5.0`;
                ratingCount.textContent = `(Based on ${feedback.length} submission${feedback.length === 1 ? '' : 's'})`;
            }

            /**
             * Renders the feedback data into the admin table.
             */
            function renderFeedbackTable(feedback) {
                const tableBody = document.getElementById('feedback-table-body');
                if (!tableBody) {
                    console.error("Feedback table body not found!");
                    return;
                }
                
                tableBody.innerHTML = ''; // Clear existing table
                
                if (feedback.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No feedback submitted yet.</td></tr>';
                    return;
                }

                // Sort feedback by timestamp, newest first
                feedback.sort((a, b) => {
                    const aTime = a.timestamp ? a.timestamp.toMillis() : 0;
                    const bTime = b.timestamp ? b.timestamp.toMillis() : 0;
                    return bTime - aTime;
                });

                feedback.forEach(entry => {
                    const row = document.createElement('tr');
                    const submittedDate = entry.timestamp ? entry.timestamp.toDate().toLocaleString() : 'Just now';
                    
                    row.innerHTML = `
                        <td class="whitespace-nowrap py-4 px-4 text-sm text-gray-500">${entry.clarity}</td>
                        <td class="whitespace-nowrap py-4 px-4 text-sm text-gray-500">${entry.engagement}</td>
                        <td class="whitespace-nowrap py-4 px-4 text-sm text-gray-500">${entry.pace}</td>
                        <td class="py-4 px-4 text-sm text-gray-500 min-w-[150px] whitespace-pre-wrap break-words">${entry.positive || ''}</td>
                        <td class="py-4 px-4 text-sm text-gray-500 min-w-[150px] whitespace-pre-wrap break-words">${entry.negative || ''}</td>
                        <td class="whitespace-nowrap py-4 px-4 text-sm text-gray-500">${submittedDate}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            /**
             * Handles the student feedback form submission.
             */
            async function handleFormSubmit(e) {
                e.preventDefault();
                
                // Check if we have a valid survey
                if (!currentSurveyId) {
                    alert("No survey selected. Please use a valid survey link.");
                    return;
                }
                
                showCustomConfirm(
                    "Submit Feedback?",
                    "Are you sure you want to submit this feedback? You cannot edit it later.",
                    async () => {
                        // --- This runs if user clicks "Confirm" ---
                        try {
                            console.log("Starting feedback submission for survey:", currentSurveyId);
                            const formData = new FormData(feedbackForm);
                            const clarity = parseFloat(formData.get('clarity'));
                            const engagement = parseFloat(formData.get('engagement'));
                            const pace = parseFloat(formData.get('pace'));
                            
                            console.log("Form ratings:", { clarity, engagement, pace });
                            
                            // Get submission token for this survey
                            const token = await getOrCreateSurveyToken(currentSurveyId);
                            console.log("Using token:", token);
                            
                            // Generate device fingerprint
                            const fingerprint = await generateBrowserFingerprint();
                            console.log("Device fingerprint:", fingerprint);
                            
                            const newSubmission = {
                                surveyId: currentSurveyId,
                                token: token,
                                fingerprint: fingerprint, // Store fingerprint for cross-browser detection
                                clarity,
                                engagement,
                                pace,
                                positive: formData.get('positive-comments'),
                                negative: formData.get('negative-comments'),
                                average: (clarity + engagement + pace) / 3,
                                timestamp: serverTimestamp(),
                                userId: currentUser ? currentUser.uid : null // For analytics only
                            };

                            const submissionDocRef = getSubmissionDocRef(currentSurveyId, token);
                            console.log("Submission doc path:", submissionDocRef.path);
                            
                            // Check both token and fingerprint
                            const alreadySubmitted = await checkTokenSubmission(currentSurveyId, token);
                            console.log("Already submitted (token)?", alreadySubmitted);

                            if (alreadySubmitted) {
                                console.warn("Duplicate submission attempt detected for token", token);
                                feedbackFormContainer.classList.add('hidden');
                                successMessage.classList.remove('hidden');
                                return;
                            }
                            
                            const fingerprintUsed = await checkFingerprintSubmission(currentSurveyId, fingerprint);
                            console.log("Already submitted (fingerprint)?", fingerprintUsed);
                            
                            if (fingerprintUsed) {
                                console.warn("Duplicate submission attempt detected for fingerprint", fingerprint);
                                alert("This device has already submitted feedback for this survey. Multiple submissions from the same device are not allowed.");
                                return;
                            }

                            // Persist submission using deterministic document id
                            console.log("Writing submission to Firestore...");
                            await setDoc(submissionDocRef, newSubmission);
                            console.log("‚úÖ Feedback submitted successfully with token:", token);

                            // Update UI
                            feedbackFormContainer.classList.add('hidden');
                            successMessage.classList.remove('hidden');
                            feedbackForm.reset(); // Clear the form
                            
                            console.log("‚úÖ Feedback submitted successfully with token:", token);
                        
                        } catch (error) {
                            console.error("‚ùå Error submitting feedback:", error);
                            console.error("Error details:", error.code, error.message);
                            alert("Error: Could not submit feedback. Please try again.");
                        }
                    },
                    "Submit" // Change confirm button text
                );
            }

            /**
             * Handles the admin login form submission.
             */
            async function handleLoginFormSubmit(e) {
                e.preventDefault();
                
                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;
                
                // Check if Firebase is initialized
                if (!auth) {
                    console.error("Firebase Auth not initialized yet");
                    adminErrorMessage.textContent = "System not ready. Please wait a moment and try again.";
                    adminErrorMessage.classList.remove('hidden');
                    return;
                }
                
                // Disable submit button and show loading state
                adminLoginSubmit.disabled = true;
                adminLoginSubmit.textContent = 'Signing in...';
                adminErrorMessage.classList.add('hidden');
                
                try {
                    // Sign out current user first (if anonymous)
                    if (currentUser && currentUser.isAnonymous) {
                        await signOut(auth);
                    }
                    
                    // Sign in admin with email and password
                    await signInWithEmailAndPassword(auth, email, password);
                    
                    // Success - Firebase auth state listener will handle the rest
                    console.log("Admin login successful");
                    adminLoginForm.reset();
                    adminLoginModal.classList.add('hidden');
                    
                } catch (error) {
                    console.error("Admin login failed:", error);
                    console.error("Error code:", error.code);
                    console.error("Error message:", error.message);
                    console.error("Attempted email:", email);
                    
                    // Show appropriate error message
                    let errorMessage = "Login failed. Please check your credentials.";
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = "Admin account not found.";
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = "Incorrect password.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Invalid email address.";
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = "Too many failed attempts. Please try again later.";
                    } else if (error.code === 'auth/invalid-credential') {
                        errorMessage = "Invalid credentials. Please check your email and password.";
                    }
                    
                    adminErrorMessage.textContent = errorMessage;
                    adminErrorMessage.classList.remove('hidden');
                    
                    // Fall back to anonymous auth for students
                    try {
                        await signInAnonymously(auth);
                    } catch (fallbackError) {
                        console.error("Failed to restore anonymous auth:", fallbackError);
                    }
                } finally {
                    // Reset button state
                    adminLoginSubmit.disabled = false;
                    adminLoginSubmit.textContent = 'Login';
                }
            }

            /**
             * Logs the admin out and returns to anonymous authentication.
             */
            async function handleLogout() {
                try {
                    // Sign out current user
                    await signOut(auth);
                    
                    // Sign back in anonymously for students
                    await signInAnonymously(auth);
                    
                    console.log("Admin logged out, returned to anonymous access");
                } catch (error) {
                    console.error("Error during logout:", error);
                    // Force refresh if logout fails
                    window.location.reload();
                }
            }

            /**
             * Saves the module code to Firestore.
             */
            async function handleSaveTitle() {
                const newTitle = moduleCodeInput.value.trim();
                const currentDate = lectureDateInput.value;
                
                try {
                    await setDoc(doc(db, SETTINGS_DOC), { 
                        moduleCode: newTitle,
                        lectureDate: currentDate 
                    }, { merge: true });
                    
                    // Update admin panel title immediately
                    const adminTitle = newTitle ? `${newTitle}:${currentDate}<br>Overall Rating<br>-------------------` : "Overall Rating<br>-------------------";
                    adminPanelTitle.innerHTML = adminTitle;

                    // Show saved message
                    titleSavedMessage.classList.remove('hidden');
                    setTimeout(() => {
                        titleSavedMessage.classList.add('hidden');
                    }, 2000);
                } catch (error) {
                    console.error("Error saving title:", error);
                    alert("Error: Could not save module code.");
                }
            }

            /**
             * Saves the lecture date to Firestore.
             */
            async function handleSaveDate() {
                const newDate = lectureDateInput.value;
                const currentModuleCode = moduleCodeInput.value.trim();
                
                try {
                    await setDoc(doc(db, SETTINGS_DOC), { 
                        lectureDate: newDate,
                        moduleCode: currentModuleCode 
                    }, { merge: true });
                    
                    // Update admin panel title immediately
                    const adminTitle = currentModuleCode ? `${currentModuleCode}:${newDate}<br>Overall Rating<br>-------------------` : "Overall Rating<br>-------------------";
                    adminPanelTitle.innerHTML = adminTitle;

                    // Show saved message
                    dateSavedMessage.classList.remove('hidden');
                    setTimeout(() => {
                        dateSavedMessage.classList.add('hidden');
                    }, 2000);
                } catch (error) {
                    console.error("Error saving date:", error);
                    alert("Error: Could not save date.");
                }
            }

            /**
             * Saves the recovery email to Firestore.
             */
            async function handleSaveEmail() {
                if (!recoveryEmailInput) {
                    console.warn("Recovery email input not found in UI");
                    return;
                }
                const newEmail = recoveryEmailInput.value.trim();
                try {
                    adminSettings.recoveryEmail = newEmail;
                    await setDoc(doc(db, ADMIN_SETTINGS_DOC), adminSettings);

                    // Show saved message (if element exists)
                    if (emailSavedMessage) {
                        emailSavedMessage.classList.remove('hidden');
                        setTimeout(() => {
                            emailSavedMessage.classList.add('hidden');
                        }, 2000);
                    }
                } catch (error) {
                    console.error("Error saving recovery email:", error);
                    alert("Error: Could not save recovery email.");
                }
            }

            /**
             * Handles password change using Firebase Authentication.
             */
            async function handleChangePassword() {
                // Check if password elements exist
                if (!currentPasswordInput || !newPasswordInput || !confirmPasswordInput) {
                    console.warn("Password change UI elements not found");
                    return;
                }
                
                const currentPassword = currentPasswordInput.value;
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                // Clear previous messages
                if (passwordChangeMessage) {
                    passwordChangeMessage.classList.add('hidden');
                }

                if (!currentPassword) {
                    showPasswordMessage("Please enter your current password.", "error");
                    return;
                }

                // Validate new password
                if (newPassword.length < 6) {
                    showPasswordMessage("New password must be at least 6 characters long.", "error");
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showPasswordMessage("New passwords do not match.", "error");
                    return;
                }

                if (newPassword === currentPassword) {
                    showPasswordMessage("New password must be different from current password.", "error");
                    return;
                }

                try {
                    const user = auth.currentUser;
                    if (!user) {
                        showPasswordMessage("Error: Not authenticated.", "error");
                        return;
                    }

                    // Re-authenticate user with current password
                    const credential = EmailAuthProvider.credential(user.email, currentPassword);
                    await reauthenticateWithCredential(user, credential);

                    // Update password
                    await updatePassword(user, newPassword);

                    // Clear password fields
                    currentPasswordInput.value = '';
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';

                    showPasswordMessage("Password changed successfully!", "success");
                } catch (error) {
                    console.error("Error changing password:", error);
                    
                    let errorMessage = "Error: Could not change password.";
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = "Current password is incorrect.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = "New password is too weak.";
                    } else if (error.code === 'auth/requires-recent-login') {
                        errorMessage = "Please log out and log in again before changing password.";
                    }
                    
                    showPasswordMessage(errorMessage, "error");
                }
            }

            /**
             * Shows password change message.
             */
            function showPasswordMessage(message, type) {
                if (!passwordChangeMessage) {
                    console.log(message); // Fallback to console if UI element doesn't exist
                    return;
                }
                
                passwordChangeMessage.textContent = message;
                passwordChangeMessage.classList.remove('hidden', 'text-green-600', 'text-red-600');
                passwordChangeMessage.classList.add(type === 'success' ? 'text-green-600' : 'text-red-600');
                
                if (type === 'success') {
                    setTimeout(() => {
                        passwordChangeMessage.classList.add('hidden');
                    }, 3000);
                }
            }

            /**
             * Handles forgot password functionality.
             */
            function handleForgotPassword() {
                adminLoginModal.classList.add('hidden');
                passwordRecoveryModal.classList.remove('hidden');
            }

            /**
             * Handles password recovery form submission using Firebase.
             */
            async function handlePasswordRecovery(e) {
                e.preventDefault();
                const emailInput = document.getElementById('recovery-email-check');
                const email = emailInput.value.trim();

                // Hide previous messages
                recoveryErrorMessage.classList.add('hidden');
                recoverySuccessMessage.classList.add('hidden');

                if (!email) {
                    recoveryErrorMessage.textContent = "Please enter an email address.";
                    recoveryErrorMessage.classList.remove('hidden');
                    return;
                }

                // Disable submit button and show loading state
                recoverySubmitButton.disabled = true;
                recoverySubmitButton.textContent = 'Sending...';

                try {
                    // Send password reset email using Firebase
                    await sendPasswordResetEmail(auth, email);
                    
                    recoverySuccessMessage.textContent = "Password reset email sent! Check your inbox and spam folder.";
                    recoverySuccessMessage.classList.remove('hidden');
                    
                    // Auto-close modal after 5 seconds
                    setTimeout(() => {
                        passwordRecoveryModal.classList.add('hidden');
                        recoverySuccessMessage.classList.add('hidden');
                        emailInput.value = '';
                    }, 5000);
                    
                } catch (error) {
                    console.error("Error during password recovery:", error);
                    
                    let errorMessage = "Failed to send reset email.";
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = "No admin account found with this email address.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Invalid email address.";
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = "Too many requests. Please try again later.";
                    }
                    
                    recoveryErrorMessage.textContent = errorMessage;
                    recoveryErrorMessage.classList.remove('hidden');
                } finally {
                    // Reset button state
                    recoverySubmitButton.disabled = false;
                    recoverySubmitButton.textContent = 'Send Reset Email';
                }
            }

            /**
             * Resets all feedback data from Firestore.
             * Now deletes from survey-submissions collection.
             */
            async function resetAllFeedback() {
                showCustomConfirm(
                    "Reset All Feedback?",
                    "This will delete *all* feedback from the database permanently. This action cannot be undone.",
                    async () => {
                        try {
                            const q = query(collection(db, SUBMISSIONS_COLLECTION));
                            const querySnapshot = await getDocs(q);
                            
                            // Delete all documents in parallel
                            const deletePromises = [];
                            querySnapshot.forEach((doc) => {
                                deletePromises.push(deleteDoc(doc.ref));
                            });
                            await Promise.all(deletePromises);
                            
                            // Also clear the title (legacy)
                            await setDoc(doc(db, SETTINGS_DOC), { moduleCode: "" });
                            
                            // Clear local submitted flags (optional, but good for testing)
                            localStorage.removeItem(SUBMITTED_KEY);
                            
                            console.log("All feedback reset.");
                            loadAdminPanelData(); // Refresh admin panel
                        } catch (error) {
                            console.error("Error resetting feedback:", error);
                            alert("Error: Could not reset feedback.");
                        }
                    }
                );
            }

            /**
             * Handles the PDF download.
             */
            async function handleDownloadPdf() {
                const { jsPDF } = window.jspdf;
                const content = document.getElementById('pdf-content-wrapper');
                
                if (!content) {
                    console.error("PDF content wrapper not found!");
                    return;
                }
                
                // Show loading state
                const originalButtonText = downloadPdfButton.textContent;
                downloadPdfButton.textContent = 'Generating PDF...';
                downloadPdfButton.disabled = true;
                
                try {
                    // Prepare content for PDF capture
                    // Remove problematic classes and add PDF-specific styling
                    content.style.width = 'auto';
                    content.style.maxWidth = 'none';
                    content.style.overflow = 'visible';
                    content.classList.add('pdf-export');
                    
                    // Fix table layout for PDF
                    const table = content.querySelector('table');
                    if (table) {
                        table.style.width = '100%';
                        table.style.tableLayout = 'fixed';
                        table.style.wordWrap = 'break-word';
                        
                        // Ensure all cells are visible
                        const cells = table.querySelectorAll('th, td');
                        cells.forEach(cell => {
                            cell.style.whiteSpace = 'normal';
                            cell.style.wordBreak = 'break-word';
                            cell.style.padding = '8px';
                        });
                    }
                    
                    // Wait for any layout changes to complete
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    const canvas = await html2canvas(content, {
                        scale: 1.5, // Balanced scale for quality vs performance
                        useCORS: true,
                        logging: false,
                        width: content.scrollWidth,
                        height: content.scrollHeight,
                        scrollX: 0,
                        scrollY: 0,
                        allowTaint: true,
                        backgroundColor: '#ffffff'
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Calculate PDF dimensions - use A4 with margins
                    const pdfWidth = 210; // A4 width in mm
                    const pdfHeight = 297; // A4 height in mm
                    const margin = 15; // 15mm margins
                    const contentWidth = pdfWidth - (margin * 2);
                    const contentHeight = pdfHeight - (margin * 2);
                    
                    // Calculate scale to fit content within page
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const scaleX = contentWidth / (imgWidth * 0.264583); // Convert px to mm
                    const scaleY = contentHeight / (imgHeight * 0.264583);
                    const scale = Math.min(scaleX, scaleY, 1); // Don't upscale
                    
                    const scaledWidth = (imgWidth * 0.264583) * scale;
                    const scaledHeight = (imgHeight * 0.264583) * scale;
                    
                    const pdf = new jsPDF({
                        orientation: scaledHeight > scaledWidth ? 'portrait' : 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Center the content on the page
                    const x = (pdfWidth - scaledWidth) / 2;
                    const y = margin;
                    
                    pdf.addImage(imgData, 'PNG', x, y, scaledWidth, scaledHeight);
                    
                    // Add footer with generation time
                    const generatedTime = `Report Generated: ${new Date().toLocaleString()}`;
                    pdf.setFontSize(8);
                    pdf.setTextColor(128, 128, 128); // Gray color
                    const textWidth = pdf.getStringUnitWidth(generatedTime) * pdf.getFontSize() / pdf.internal.scaleFactor;
                    const textX = (pdfWidth - textWidth) / 2;
                    pdf.text(generatedTime, textX, pdfHeight - 10);
                    
                    const moduleCode = moduleCodeInput.value.trim() || "Feedback-Report";
                    pdf.save(`${moduleCode.replace(/[^a-z0-9]/gi, '_')}-Report.pdf`);

                } catch (error) {
                    console.error("Error generating PDF:", error);
                    alert("Could not generate PDF. See console for details.");
                } finally {
                    // Reset button state
                    downloadPdfButton.textContent = originalButtonText;
                    downloadPdfButton.disabled = false;
                    
                    // Clean up styles
                    content.style.width = '';
                    content.style.maxWidth = '';
                    content.style.overflow = '';
                    content.classList.remove('pdf-export');
                    
                    // Reset table styles
                    const table = content.querySelector('table');
                    if (table) {
                        table.style.width = '';
                        table.style.tableLayout = '';
                        table.style.wordWrap = '';
                        
                        const cells = table.querySelectorAll('th, td');
                        cells.forEach(cell => {
                            cell.style.whiteSpace = '';
                            cell.style.wordBreak = '';
                            cell.style.padding = '';
                        });
                    }
                }
            }
            
            // --- Custom Modals ---

            /**
             * Shows the custom confirmation modal.
             * @param {string} title - The title for the modal.
             * @param {string} message - The message body.
             * @param {function} onConfirm - The callback function to run if "OK" is clicked.
             * @param {string} [okText='Confirm'] - Optional text for the confirm button.
             */
            function showCustomConfirm(title, message, onConfirm, okText = 'Confirm') {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                confirmOkButton.textContent = okText;
                
                // Set button color
                if (okText.toLowerCase().includes('submit')) {
                    confirmOkButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                    confirmOkButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    confirmOkButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    confirmOkButton.classList.add('bg-red-600', 'hover:bg-red-700');
                }
                
                confirmCallback = onConfirm; // Store the callback
                confirmModal.classList.remove('hidden');
            }

            /**
             * Hides the custom confirmation modal.
             */
            function hideCustomConfirm() {
                confirmCallback = null; // Clear the callback
                if (confirmModal) {
                    confirmModal.classList.add('hidden');
                }
            }

            // --- EVENT LISTENERS ---
            if (adminButton) {
                adminButton.addEventListener('click', () => {
                    if (adminLoginModal) {
                        adminLoginModal.classList.remove('hidden');
                    }
                });
            }
            if (adminCancelButton) {
                adminCancelButton.addEventListener('click', () => {
                    if (adminLoginModal) {
                        adminLoginModal.classList.add('hidden');
                    }
                });
            }
            if (adminLoginForm) {
                adminLoginForm.addEventListener('submit', handleLoginFormSubmit);
            }
            if (forgotPasswordButton) {
                forgotPasswordButton.addEventListener('click', handleForgotPassword);
            }
            
            if (recoveryCancelButton) {
                recoveryCancelButton.addEventListener('click', () => {
                    if (passwordRecoveryModal) {
                        passwordRecoveryModal.classList.add('hidden');
                    }
                    if (recoveryErrorMessage) {
                        recoveryErrorMessage.classList.add('hidden');
                    }
                    if (recoverySuccessMessage) {
                        recoverySuccessMessage.classList.add('hidden');
                    }
                    const recoveryEmailCheckInput = document.getElementById('recovery-email-check');
                    if (recoveryEmailCheckInput) {
                        recoveryEmailCheckInput.value = '';
                    }
                });
            }
            if (passwordRecoveryForm) {
                passwordRecoveryForm.addEventListener('submit', handlePasswordRecovery);
            }
            
            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
            }
            
            if (feedbackForm) {
                feedbackForm.addEventListener('submit', handleFormSubmit);
            }
            
            if (saveTitleButton) {
                saveTitleButton.addEventListener('click', handleSaveTitle);
            }
            if (saveDateButton) {
                saveDateButton.addEventListener('click', handleSaveDate);
            }
            if (resetFeedbackButton) {
                resetFeedbackButton.addEventListener('click', resetAllFeedback);
            }
            if (downloadPdfButton) {
                downloadPdfButton.addEventListener('click', handleDownloadPdf);
            }
            
            // Survey management event listener
            if (createSurveyButton) {
                createSurveyButton.addEventListener('click', createSurvey);
            }
            
            // Confirmation modal buttons
            if (confirmCancelButton) {
                confirmCancelButton.addEventListener('click', hideCustomConfirm);
            }
            if (confirmOkButton) {
                confirmOkButton.addEventListener('click', () => {
                    if (typeof confirmCallback === 'function') {
                        confirmCallback(); // Execute the stored callback
                    }
                    hideCustomConfirm(); // Hide modal after action
                });
            }

            // --- INITIALIZATION ---
            
            // Set a timeout to enable admin button if Firebase doesn't initialize
            setTimeout(() => {
                if (adminButton.disabled) {
                    console.warn("‚ö†Ô∏è Firebase initialization timeout - enabling admin button");
                    adminButton.textContent = "Admin (Click to View)";
                    adminButton.disabled = false;
                    adminButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    adminButton.classList.remove('bg-gray-700', 'hover:bg-gray-800');
                }
            }, 3000); // 3 second timeout
            
            // Initialize Firebase (normal mode)
            initializeFirebase().catch(err => {
                console.error("Firebase initialization failed:", err);
                adminButton.textContent = "Admin (Error)";
                adminButton.disabled = false;
                adminButton.classList.add('bg-red-600', 'hover:bg-red-700');
                adminButton.classList.remove('bg-gray-700', 'hover:bg-gray-800');
            });
        });
    </script>
</body>
</html>

